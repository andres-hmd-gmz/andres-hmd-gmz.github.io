<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog — Andrés Ahumada Gómez</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="site-header">
    <a class="brand" href="/es/">
      <img src="/imgs/andres-esf2.png" alt="Logo" class="brand-logo">
      Andrés Ahumada Gómez
    </a>
    <nav class="nav">
      <a href="/es/">Inicio</a>
      <a class="active" href="/es/blog/">Blog</a>
    </nav>
  </header>

  <main class="container">
    <h1>Blog</h1>
    <p class="lead">Entradas clasificadas por tema y por mes–año.</p>

    <section class="grid">
      <div class="card">
        <h3>Filtrar por tema</h3>
        <select id="topicSelect" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,.12);">
          <option value="">Todos los temas</option>
        </select>

        <div style="margin-top:12px;">
          <input id="searchInput" type="search" placeholder="Buscar en títulos/resumen…"
            style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,.12);" />
        </div>
      </div>

      <div class="card">
        <h3>Archivo</h3>
        <div id="archive"></div>
      </div>
    </section>

    <section class="section">
      <div class="card">
        <h3>Resultados</h3>
        <div id="results"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <small>© <span id="year"></span> Andrés Ahumada Gómez</small>
    </div>
  </footer>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const topicSelect = document.getElementById("topicSelect");
    const searchInput = document.getElementById("searchInput");
    const archiveEl = document.getElementById("archive");
    const resultsEl = document.getElementById("results");

    function formatMonthYear(isoDate){
      const d = new Date(isoDate + "T00:00:00");
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`; // clave de agrupación
    }

    function formatDateEs(isoDate){
      const d = new Date(isoDate + "T00:00:00");
      return d.toLocaleDateString("es-ES", { year:"numeric", month:"long", day:"2-digit" });
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildTopics(posts){
      const topics = [...new Set(posts.map(p => p.topic).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"es"));
      for(const t of topics){
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        topicSelect.appendChild(opt);
      }
    }

    function buildArchive(posts){
      // Agrupa por YYYY-MM
      const groups = new Map();
      for(const p of posts){
        const key = formatMonthYear(p.date);
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(p);
      }
      // Orden descendente por mes
      const keys = [...groups.keys()].sort().reverse();

      archiveEl.innerHTML = keys.map(key => {
        const items = groups.get(key)
          .sort((a,b)=> b.date.localeCompare(a.date))
          .map(p => `
            <li>
              <a href="${escapeHtml(p.url)}">${escapeHtml(p.title)}</a>
              <span style="color:var(--muted)"> — ${escapeHtml(p.topic || "")}</span>
              <div style="color:var(--muted); font-size:0.95rem;">${escapeHtml(p.excerpt || "")}</div>
            </li>
          `).join("");

        return `
          <h2 style="margin:16px 0 8px;">${escapeHtml(key)}</h2>
          <ul style="margin:0; padding-left:18px;">${items}</ul>
        `;
      }).join("");
    }

    function renderResults(posts){
      const topic = topicSelect.value.trim();
      const q = searchInput.value.trim().toLowerCase();

      const filtered = posts.filter(p => {
        const okTopic = !topic || p.topic === topic;
        const hay = `${p.title || ""} ${p.excerpt || ""}`.toLowerCase();
        const okSearch = !q || hay.includes(q);
        return okTopic && okSearch;
      }).sort((a,b)=> b.date.localeCompare(a.date));

      if(filtered.length === 0){
        resultsEl.innerHTML = `<p style="color:var(--muted); margin:0;">No hay entradas que coincidan.</p>`;
        return;
      }

      resultsEl.innerHTML = filtered.map(p => `
        <div style="padding:12px 0; border-bottom:1px solid rgba(0,0,0,.08);">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:baseline;">
            <a href="${escapeHtml(p.url)}" style="font-weight:700;">${escapeHtml(p.title)}</a>
            <span style="color:var(--muted);">(${escapeHtml(formatDateEs(p.date))})</span>
            ${p.topic ? `<span class="tags"><span>${escapeHtml(p.topic)}</span></span>` : ``}
          </div>
          ${p.excerpt ? `<div style="color:var(--muted); margin-top:6px;">${escapeHtml(p.excerpt)}</div>` : ``}
        </div>
      `).join("");
    }

    async function init(){
      const res = await fetch("/es/blog/posts.json", { cache: "no-store" });
      if(!res.ok){
        resultsEl.innerHTML = `<p style="color:var(--muted);">No pude cargar posts.json</p>`;
        return;
      }
      const posts = await res.json();

      // Normaliza y valida mínimamente
      for(const p of posts){
        if(!p.title || !p.date || !p.url) console.warn("Post incompleto:", p);
      }

      buildTopics(posts);
      buildArchive(posts);
      renderResults(posts);

      topicSelect.addEventListener("change", ()=>renderResults(posts));
      searchInput.addEventListener("input", ()=>renderResults(posts));
    }

    init();
  </script>
</body>
</html>
